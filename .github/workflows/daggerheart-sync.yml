name: Daggerheart SRD Sync

on:
  push:
    paths:
      - 'contents/**'
    branches:
      - main

jobs:
  daggerheart-sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repositório
      uses: actions/checkout@v4

    - name: Detectar arquivos modificados
      id: diff
      run: |
        git fetch origin main
        git diff --name-only HEAD~1 HEAD > changed_files.txt
        echo "CHANGED=$(cat changed_files.txt | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_ENV

    - name: Criar prompt com mudanças
      run: |
        echo "Resumo automático de alterações no conteúdo Daggerheart:" > prompt.txt
        echo "" >> prompt.txt
        while read -r file; do
          if [ -f "$file" ]; then
            echo "---- $file ----" >> prompt.txt
            head -n 200 "$file" >> prompt.txt
            echo "" >> prompt.txt
          fi
        done < changed_files.txt
        head -c 30000 prompt.txt > prompt_clipped.txt

    - name: Enviar para Coração de Adaga
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        CUSTOM_MODEL_ID: ${{ secrets.CUSTOM_MODEL_ID }}
      run: |
        sudo apt-get update && sudo apt-get install -y jq

        PROMPT=$(jq -Rs . < prompt_clipped.txt)
        MODEL="${CUSTOM_MODEL_ID:-gpt-5-coração-de-adaga}"

        RESP=$(cat <<'EOF' | curl -s -X POST "https://api.openai.com/v1/chat/completions" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -H "Content-Type: application/json" \
          -d @-)
{
  "model": "${MODEL}",
  "messages": [
    {"role": "system", "content": "Você é Coração de Adaga, um narrador e arquivista de regras de Daggerheart. Gere um resumo das mudanças."},
    {"role": "user", "content": ${PROMPT}}
  ],
  "max_tokens": 800
}
EOF

        echo "$RESP" > response.json
        jq -r '.choices[0].message.content' response.json > session_log.md

    - name: Commitar resultado no repositório
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add session_log.md
        git commit -m "Atualização automática de log de sessão" || echo "Sem mudanças"
        git push
